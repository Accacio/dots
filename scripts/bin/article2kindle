#!/bin/bash

outDir=${1/.pdf}
[ -d $outDir ] || mkdir $outDir
cp $1 $outDir
cd $outDir
mkdir -p OEBPS/Images OEBPS/Text META-INF

# convert $1 OEBPS/Images/page.jpg
convert -density 300 $1 OEBPS/Images/page.jpg

echo -e "application/epub+zip\c"> mimetype
echo -e "<?xml version=\"1.0\"?>
<container version=\"1.0\" xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\">
<rootfiles>
<rootfile full-path=\"OEBPS/content.opf\" media-type=\"application/oebps-package+xml\"/>
</rootfiles>
</container>\c"> META-INF/container.xml
echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?>
<ncx version=\"2005-1\" xml:lang=\"en-US\" xmlns=\"http://www.daisy.org/z3986/2005/ncx/\">
<head>
<meta name=\"dtb:uid\" content=\"urn:uuid:$(cat /proc/sys/kernel/random/uuid)\"/>
<meta name=\"dtb:depth\" content=\"1\"/>
<meta name=\"dtb:totalPageCount\" content=\"0\"/>
<meta name=\"dtb:maxPageNumber\" content=\"0\"/>
<meta name=\"generated\" content=\"true\"/>
</head>
<docTitle><text>forteb</text></docTitle>
<navMap>
<navPoint id=\"Text\"><navLabel><text>forteb</text></navLabel><content src=\"Text/"$(find OEBPS/Images/*  -printf "%f\n" | sed 1q | sed "s/.jpg//")".xhtml\"/></navPoint>
</navMap>
</ncx>\c" > OEBPS/toc.ncx
echo -e "<?xml version=\"1.0\" encoding=\"utf-8\"?>
<!DOCTYPE html>
<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\">
<head>
<title>"$(pdfinfo $1 | grep Title | sed -e "s/:\ */:/g"| cut -d":" -f 2)"</title>
<meta charset=\"utf-8\"/>
</head>
<body>
<nav xmlns:epub=\"http://www.idpf.org/2007/ops\" epub:type=\"toc\" id=\"toc\">
<ol>
<li><a href=\"Text/$(find OEBPS/Images/*  -printf "%f\n" | sed 1q | sed "s/.jpg//").xhtml\">forteb</a></li>
</ol>
</nav>
<nav epub:type=\"page-list\">
<ol>
<li><a href=\"Text/$(find OEBPS/Images/*  -printf "%f\n" | sed 1q | sed "s/.jpg//").xhtml\">forteb</a></li>
</ol>
</nav>
</body>
</html>\c" > OEBPS/nav.xhtml

echo -e "<?xml version=\"1.0\" encoding=\"UTF-8\"?>
<package version=\"3.0\" unique-identifier=\"BookID\" xmlns=\"http://www.idpf.org/2007/opf\">
<metadata xmlns:opf=\"http://www.idpf.org/2007/opf\" xmlns:dc=\"http://purl.org/dc/elements/1.1/\">
<dc:title>"$(pdfinfo $1 | grep Title | sed -e "s/:\ */:/g"| cut -d":" -f 2)"</dc:title>
<dc:language>en-US</dc:language>
<dc:identifier id=\"BookID\">urn:uuid:5adbc57e-fbc6-4e22-99a5-9b05881084b8</dc:identifier>
<dc:contributor id=\"contributor\">Accacio</dc:contributor>
<dc:creator>Accacio</dc:creator>
<meta property=\"dcterms:modified\">\" $(date +%FT%XZ) \"</meta>
<meta name=\"cover\" content=\"cover\"/>
<meta name=\"fixed-layout\" content=\"true\"/>
<meta name=\"original-resolution\" content=\"1264x1680\"/>
<meta name=\"book-type\" content=\"comic\"/>
<meta name=\"primary-writing-mode\" content=\"vertical-lr\"/>
<meta name=\"zero-gutter\" content=\"true\"/>
<meta name=\"zero-margin\" content=\"true\"/>
<meta name=\"ke-border-color\" content=\"#FFFFFF\"/>
<meta name=\"ke-border-width\" content=\"0\"/>
<meta name=\"orientation-lock\" content=\"portrait\"/>
<meta name=\"region-mag\" content=\"true\"/>
</metadata>
<manifest>
<item id=\"ncx\" href=\"toc.ncx\" media-type=\"application/x-dtbncx+xml\"/>
<item id=\"nav\" href=\"nav.xhtml\" properties=\"nav\" media-type=\"application/xhtml+xml\"/>
$(find OEBPS/Images/*  -printf "%f\n" | sed 1q | awk '{print "<item id=" "\x22" "cover" "\x22" " href=" "\x22" "Images/" $1 "\x22" " media-type=" "\x22" "image/jpeg" "\x22" " properties=" "\x22" "cover-image"  "\x22"  "/>"}' )
$(find OEBPS/Images/*  -printf "%f\n" | awk '{print "<item id=" "\x22" "image_" $1 "\x22" " href=" "\x22" "Images/" $1 "\x22" " media-type=" "\x22" "image/jpeg" "\x22" "/>"}' | sed "s/.jpg//")
$(find OEBPS/Images/*  -printf "%f\n" | awk '{print "<item id=" "\x22" "page_" $1 "\x22" " href=" "\x22" "Text/" $1 ".xhtml\x22  media-type=" "\x22" "application/xhtml+xml" "\x22" "/>"}' | sed "s/.jpg//g")
<item id=\"css\" href=\"Text/style.css\" media-type=\"text/css\"/>
</manifest>
<spine page-progression-direction=\"ltr\" toc=\"ncx\">
$(find OEBPS/Images/*  -printf "%f\n" | awk '{print "<itemref idref=" "\x22" "page_" $1 "\x22" " linear=" "\x22" "yes" "\x22" " properties=" "\x22" "page-spread-center" "\x22" "/>"}' | sed "s/.jpg//")
</spine>
</package>\c" > OEBPS/content.opf

echo -e "@page {
margin: 0;
}
body {
display: block;
margin: 0;
padding: 0;
}
#PV {
position: absolute;
width: 100%;
height: 100%;
top: 0;
left: 0;
}
#PV-T {
top: 0;
width: 100%;
height: 50%;
}
#PV-B {
bottom: 0;
width: 100%;
height: 50%;
}
#PV-L {
left: 0;
width: 49.5%;
height: 100%;
float: left;
}
#PV-R {
right: 0;
width: 49.5%;
height: 100%;
float: right;
}
#PV-TL {
top: 0;
left: 0;
width: 49.5%;
height: 50%;
float: left;
}
#PV-TR {
top: 0;
right: 0;
width: 49.5%;
height: 50%;
float: right;
}
#PV-BL {
bottom: 0;
left: 0;
width: 49.5%;
height: 50%;
float: left;
}
#PV-BR {
bottom: 0;
right: 0;
width: 49.5%;
height: 50%;
float: right;
}
.PV-P {
width: 100%;
height: 100%;
top: 0;
position: absolute;
display: none;
}\c" > OEBPS/Text/style.css

for i in $(find OEBPS/Images/*  -printf "%f\n")
do
echo -e "<?xml version=\"1.0\" encoding=\"UTF-8\"?>
<!DOCTYPE html>
<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\">
<head>
<title>forte-s-0000-kcc</title>
<link href=\"style.css\" type=\"text/css\" rel=\"stylesheet\"/>
<meta name=\"viewport\" content=\"width=1165, height=1680\"/>
</head>
<body style=\"\">
<div style=\"text-align:center;top:0.0%;\">
<img width=\"1165\" height=\"1680\" src=\"../Images/"$i"\"/>
</div>
<div id=\"PV\">
<div id=\"PV-TL\">
<a style=\"display:inline-block;width:100%;height:100%;\" class=\"app-amzn-magnify\" data-app-amzn-magnify='{\"targetId\":\"PV-TL-P\", \"ordinal\":1}'></a>
</div>
<div id=\"PV-BL\">
<a style=\"display:inline-block;width:100%;height:100%;\" class=\"app-amzn-magnify\" data-app-amzn-magnify='{\"targetId\":\"PV-BL-P\", \"ordinal\":2}'></a>
</div>
<div id=\"PV-TR\">
<a style=\"display:inline-block;width:100%;height:100%;\" class=\"app-amzn-magnify\" data-app-amzn-magnify='{\"targetId\":\"PV-TR-P\", \"ordinal\":3}'></a>
</div>
<div id=\"PV-BR\">
<a style=\"display:inline-block;width:100%;height:100%;\" class=\"app-amzn-magnify\" data-app-amzn-magnify='{\"targetId\":\"PV-BR-P\", \"ordinal\":4}'></a>
</div>
</div>
<div class=\"PV-P\" id=\"PV-TL-P\" style=\"\">
<img style=\"position:absolute;left:0;top:0;\" src=\"../Images/"$i"\" width=\"1747\" height=\"2520\"/>
</div>
<div class=\"PV-P\" id=\"PV-BL-P\" style=\"\">
<img style=\"position:absolute;left:0;bottom:0;\" src=\"../Images/"$i"\" width=\"1747\" height=\"2520\"/>
</div>
<div class=\"PV-P\" id=\"PV-TR-P\" style=\"\">
<img style=\"position:absolute;right:0;top:0;\" src=\"../Images/"$i"\" width=\"1747\" height=\"2520\"/>
</div>
<div class=\"PV-P\" id=\"PV-BR-P\" style=\"\">
<img style=\"position:absolute;right:0;bottom:0;\" src=\"../Images/"$i"\" width=\"1747\" height=\"2520\"/>
</div>
</body>
</html>\c" > OEBPS/Text/${i/.jpg/.xhtml}
done
rm $1
zip -X0 ../${1/.pdf}.epub "mimetype"
zip -Xr ../${1/.pdf}.epub META-INF/ OEBPS
cd ..
# rm -rf ${1/.pdf}
kindlegen -c2 ${1/.pdf/.epub}
